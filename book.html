<!DOCTYPE html>
<html>

<head>
    <title>ZeroSchool - Book</title>
    <link rel="stylesheet" href="https://unpkg.com/terminal.css@0.7.1/dist/terminal.min.css" />
    <link href="https://unpkg.com/nes.css@2.3.0/css/nes.min.css" rel="stylesheet">
    <link href="https://unpkg.com/dialog-polyfill@0.5.1/dist/dialog-polyfill.css" rel="stylesheet" type="text/css">
    <link href="/styles/main.css" rel="stylesheet" type="text/css">
    <link rel="shortcut icon" href="favicon.png" type="image/png">

    <script src="https://unpkg.com/dialog-polyfill@0.5.1/dist/dialog-polyfill.js"></script>
    <script src="https://unpkg.com/@twetch/sdk@0.2.4/dist/twetch.min.js"></script>
    <script src="https://unpkg.com/bsv@0.30.0/bsv.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://www.moneybutton.com/moneybutton.js"></script>
    <script src="https://publish.boostpow.com/publish.js"></script>
    <script src="https://pay.twetch.com/pay.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="apple-touch-icon" href="images/icons/apple-touch-icon.png">
    <link rel="apple-touch-startup-image" href="images/icons/apple-touch-icon.png">
</head>

<body onload="postsQuery()" class="terminal dark" style="padding-top: 15px; padding-left: 5px; padding-right: 5px; font-size: 13px;">
    <header>
    <div class="terminal-nav" style="text-align: center; align-content: center; align-items: center; justify-content: center;">
        <div class="logo terminal-prompt" style="text-align: center; align-content: center; color: #ccc;">ZeroSchool - v0.1</div>
    </div>
    <a style="color:#21e800;border-color:#21e800;" class="btn btn-primary btn-ghost" id="btnInfo" onclick="info()">Infos</a>
    <a class="btn btn-primary btn-ghost" id="btnLogin" onclick="login()" style="display:none;">Log In</a>
    <a style="color:#e80021;border-color:#e80021;" class="btn btn-primary btn-ghost" id="btnLogout" onclick="logout()" style="display:none;">Logout</a>
    <div class="topnav container">   
        <div class="nav-element">
            <a href="/index">Home</a>
            <a class="active" href="">100p</a>
            <a href="/jobs">Job List</a>
            <a href="https://dimely.io/directory" target="_blank">Talk</a>
        </div>
        </div><br>
</header>
    <div class="container with-title is-dark" id="post-container">
        <div class="flex-container">
            <form onsubmit="return false">
                <textarea type="text" id="post" class="input is-dark" placeholder="Just solve it, bro..."></textarea>
                <div id="flex-cont2">
                    <input class="btn btn-primary btn-ghost" type="submit" id="tPost" value="Post" onclick="twetchPost()">
                </div>
            </form>
        </div>
    </div>

    <br>
    <div id="aux-wrapper">
        <div class="selection">
            <div class="btn btn-primary btn-ghost btn-block is-dark" id="qselect">
                <select required id="order" class="btn btn-primary btn-ghost btn-block">
                    <option style="background-color:black;" value="0">Most Recent</option>
                    <option style="background-color:black;" value="1">Likes</option>
                    <option style="background-color:black;" value="2">PoW</option>
                </select>
            </div>
        </div>
    </div>
    
    <br>
    <div id="message-container" class="container dark" style="white-space: pre-line;"></div>

    <dialog class="terminal-card" id="loginDlg" style="background-color:black;color:white;">
        <form method="dialog"><menu class="dialog-menu">
            <p>Login with:</p>
            <a style="width:140px;color:#0021e8;border-color:#0021e8;" class="btn btn-primary btn-ghost" id="relayX" onclick="relayXLogin();dialog.close()">RelayX</a>
            <a style="width:140px;color:#21e800;border-color:#21e800;" class="btn btn-primary btn-ghost" id="MB" onclick="imbLogin();dialog.close()">MoneyButton</a>
        </menu></form>
    </dialog>
    
    <dialog class="terminal-card" style="background-color: #0f0f0f; border-color: #777; color: #ccc" id="infoDlg"></dialog>
    <dialog class="terminal-card" style="background-color: #0f0f0f; border-color: #777; color: #ccc" id="loadingDlg"></dialog>
    <hr>

    <footer style="color: #21e800"><small><center>powered by <a href="https://twetch.app">Twetch</a></center></small></footer>

</body>
    
<script src="ilitch.js"></script>
<script>
 async function getBook(){
    let book = window.location.href.split('/')[-1];
    let response = await sdk.query(`{
                allPosts(filter: {bContent: {includes: "${book}"}}, ${selOrder === '2' ? "" : "first: 100,"} ${orderBy}) {
                    nodes {bContent numLikes replyCount transaction youLiked userId userByUserId {name icon}}
                }
            }`);
    post = response.allPosts.nodes[0];
    let content = post.bContent;
    let boostValue = diffSum(post.transaction);
    post.boostValue = boostValue;
    let osTwetch = `<div id="${post.transaction}" class="nes-container with-title is-dark" style="position: relative; border-color: #777; background-color: #000000; margin-bottom: 20px;">
                    <p id="postTitle" class="title"><img class="nes-avatar is-rounded is-medium" src="${post.userByUserId.icon}"> ${post.userByUserId.name} <a href="https://twetch.app/u/${post.userId}" target="_blank">u/${posts.userId}</a>
                    </p><p class="urlFormat">${applyURLs(content)}</p>`
    osTwetch += `<div class="item" style="position: relative; height: 110px;">
                    <i class="nes-icon is-large heart ${post.youLiked === "0" ? "is-empty" : ""}"></i><var id=${post.transaction}_count style="position: absolute; left: 50px; top: 69px">${post.numLikes}</var>
                    <a href="https://search.matterpool.io/tx/${post.transaction}" target="_blank" text-decoration="none" class="txid">#txid</a>
                    <i class="nes-icon coin is-large" name="${post.userId}" style="position: absolute; right: -15px; top: 25px"></i>
                    <i class="nes-icon trophy is-large ${boostValue === 0 ? "is-empty" : ""}" name="${post.transaction}" style="position: absolute; left: 80px; top: 20px"></i>
                    <var id=${post.transaction}_diff style="position: absolute; left: 148px; top: 69px">${parseInt(boostValue)}</var>
                </div>`;
    document.getElementById('message-container').innerHTML += osTwetch + '</div>';
    //document.getElementById('twetch-container').onclick = function{getDetails()};
        
}
getBook();
</script>
  
</html>
