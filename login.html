
<html>
    <head>
        <title>ZeroSchool</title>
        <link rel="stylesheet" href="https://unpkg.com/terminal.css@0.7.1/dist/terminal.min.css" />
        <link href="https://unpkg.com/nes.css@2.3.0/css/nes.min.css" rel="stylesheet">
        <link href="https://unpkg.com/dialog-polyfill@0.5.1/dist/dialog-polyfill.css" rel="stylesheet" type="text/css">
        <link href="/styles/main.css" rel="stylesheet" type="text/css">
    </head>
    <body onload="">
        <div class="center">
            <p>Login with:</p>
            <a class="nes-btn is-primary" id="relayX" onclick="relayXLogin()">RelayX</a>
            <a class="nes-btn is-success" id="MB" onclick="imbLogin()">MoneyButton</a>
            <a class="nes-btn is-error" id="logout" onclick="logout()">Logout</a>
        </div>
    </body>
<script src="https://unpkg.com/bsv@0.30.0/bsv.min.js" defer></script>
<script src="https://unpkg.com/axios/dist/axios.min.js" defer></script>
<script src="https://www.moneybutton.com/moneybutton.js"></script>
<script src="https://one.relayx.io/relayone.js" defer></script>
<script src="https://unpkg.com/@twetch/sdk@0.2.4/dist/twetch.min.js"></script>
<script src="ilitch.js"></script>     
<script>
    const zeroURL = "https://zeroschool.org/";
    function logout(){localStorage.clear();alert("Logged out!");location.reload()}
    async function relayXLogin(){
        let token = await relayone.authBeta({withGrant:true}), res;
        localStorage.setItem('token', token);
        let [payload, signature] = token.split(".");
        const data = JSON.parse(atob(payload));
        let content = await axios.get('https://auth.twetch.app/api/v1/challenge');
        localStorage.setItem('msg', content.data.message);
        try {res = await relayone.sign(content.data.message)}catch(e){alert(e)}
        let publicKey = bsv.PublicKey.fromHex(data.pubkey);
        let signAddr = bsv.Address.fromPublicKey(publicKey);
        if (res){saveWallet(data.paymail, data.pubkey, res.value, signAddr.toString(), 'relayx')}
        if (localStorage.getItem('paymail')){window.location.href = zeroURL}
    }
    function saveWallet(paymail, pubkey, signature, address, wallet){
        localStorage.setItem('paymail', paymail);
        localStorage.setItem('pubkey', pubkey);
        localStorage.setItem('signature', signature);
        localStorage.setItem('address', address);
        localStorage.setItem('wallet', wallet);
    }
    function savePermissionToken(token) {localStorage.setItem('token', token)}
    function getPermissionForCurrentUser() {if (localStorage.getItem('token')) {return localStorage.getItem('token')}}
    const imb = new moneyButton.IMB({
        clientIdentifier: "ce4eb6ea41a4f43044dd7e71c08e50b2",
        permission: getPermissionForCurrentUser(), onNewPermissionGranted: (token) => savePermissionToken(token)
    });
    async function imbLogin(){
        let content = await axios.get('https://auth.twetch.app/api/v1/challenge');
        localStorage.setItem('msg', content.data.message);
        var cryptoOperations = [
            {name:'mySignature',method:'sign',data:localStorage.getItem('msg'),dataEncoding:'utf8',key:'identity',algorithm:'bitcoin-signed-message'},
            {name:'myPublicKey',method:'public-key',key:'identity'},{name: 'myAddress',method: 'address',key: 'identity'}
        ];
        imb.swipe({cryptoOperations: cryptoOperations,
            onCryptoOperations: (ops) => {
                saveWallet(ops[1].paymail, ops[1].value, ops[0].value, ops[2].value, 'moneybutton');
                if (localStorage.getItem('paymail')){window.location.href = zeroURL}
            }
        });
    }
</script>
</html>
